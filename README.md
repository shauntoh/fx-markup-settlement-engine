# FX Markup Simulator

A plain HTML + JavaScript simulator for FX markup math using local ECB reference data (`fx_rates.json`) and deterministic in-browser calculations.
# FX Markup Simulator

A plain HTML + JavaScript demo that simulates FX markup outcomes with automatic FX rate lookup from locally stored ECB reference data.

## What it does

The page collects:
- Transaction amount (TxAmt)
- Transaction currency (all currencies in `fx_rates.json`, including EUR)
- Settlement currency (restricted to `USD, EUR, SGD, JPY, PHP, IDR, MYR, THB`)
- FX rate (AdjustedRate, read-only)
- Reference rate adjustment % (AdjPct, default `8`)
- FX markup % (MarkupPct)

When you click **Run Settlement Agent**, it will:
1. Resolve a base FX rate from local data (direct / inversion / EUR cross)
2. Apply reference adjustment: `AdjustedRate = BaseRate × (1 - AdjPct / 100)`
3. Calculate merchant net payout and FX margin using the adjusted rate
4. Render a detailed breakdown table with metadata, derivation method, adjustment formula, and final settlement math

## Rate source and lookup

Rates are read from `fx_rates.json` generated by `scripts/update_fx_rates.py`.

Lookup order:
1. Direct rate
2. Inversion from reverse pair
3. EUR cross-rate: `A→B = (EUR→B) / (EUR→A)`
4. If unresolved, show an error and disable the run button

Settlement choices are validated in logic as well as UI options; unsupported values are coerced to the first available allowed currency.
- Transaction currency (dropdown)
- Settlement currency (dropdown)
- FX rate (BaseRate, auto-filled and read-only)
- FX markup % (MarkupPct)

When you click **Run Settlement Agent**, it will:
1. Calculate merchant net payout
2. Calculate FX margin earned
3. Show a decision explanation
4. Show a **Calculation Breakdown** table with each formula step

## Automatic FX rate data

Rates are read from `fx_rates.json`, generated by `scripts/update_fx_rates.py`.

The UI displays:
- Source
- As-of date
- Derivation note (direct / inversion / EUR cross-rate)

Lookup logic:
1. Use direct rate if available
2. Else derive by inversion if reverse rate exists
3. Else derive by EUR cross-rate: `A→B = (EUR→B) / (EUR→A)`
4. Else show an error and disable the run button

## Validation rules

- Amount must be **> 0**
- Adjusted rate must be **> 0**
- FX markup % must be **>= 0**
- Reference rate adjustment % must be **>= 0**

## Run locally

1. Refresh rates file:
1. Update rates:

```bash
python3 scripts/update_fx_rates.py
```

2. Start server:

```bash
python3 -m http.server 8000
```

3. Open:

- http://localhost:8000

## GitHub Action

`.github/workflows/update-fx.yml` runs daily and on manual dispatch to regenerate `fx_rates.json` and commit to `main` with:

- `chore: update fx rates`
