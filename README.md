# FX Markup Simulator

A plain HTML + JavaScript simulator for FX markup math using local ECB reference data (`fx_rates.json`) and deterministic in-browser calculations.

## What it does

The page collects:
- Transaction amount (TxAmt)
- Transaction currency (all currencies in `fx_rates.json`, including EUR)
- Settlement currency (restricted to `USD, EUR, SGD, JPY, PHP, IDR, MYR, THB`)
- FX rate (AdjustedRate, read-only)
- Reference rate adjustment % (AdjPct, default `9`)
- FX markup % (MarkupPct)

When you click **Run Settlement Agent**, it will:
1. Resolve a base FX rate from local data (direct / inversion / EUR cross)
2. Apply reference adjustment: `AdjustedRate = BaseRate × (1 - AdjPct / 100)`
3. Calculate merchant net payout and FX margin using the adjusted rate
4. Render a detailed breakdown table with metadata, derivation method, adjustment formula, and final settlement math

## Rate source and lookup

Rates are read from `fx_rates.json` generated by `scripts/update_fx_rates.py`.

Lookup order:
1. Direct rate
2. Inversion from reverse pair
3. EUR cross-rate: `A→B = (EUR→B) / (EUR→A)`
4. If unresolved, show an error and disable the run button

Settlement choices are validated in logic as well as UI options; unsupported values are coerced to the first available allowed currency.

## Validation rules

- Amount must be **> 0**
- Adjusted rate must be **> 0**
- FX markup % must be **>= 0**
- Reference rate adjustment % must be **>= 0**

## Run locally

1. Refresh rates file:

```bash
python3 scripts/update_fx_rates.py
```

2. Start server:

```bash
python3 -m http.server 8000
```

3. Open:

- http://localhost:8000

## GitHub Action

`.github/workflows/update-fx.yml` runs daily and on manual dispatch to regenerate `fx_rates.json` and commit to `main` with:

- `chore: update fx rates`
